// Copyright (c) .NET Foundation and contributors. All rights reserved.

#pragma warning disable IDE0130

namespace Microsoft.Extensions.DependencyInjection;

using Asp.Versioning;
using Asp.Versioning.ApiExplorer;
using Microsoft.AspNetCore.Mvc.ApiExplorer;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using Microsoft.AspNetCore.Routing;
using Microsoft.Extensions.DependencyInjection.Extensions;
using Microsoft.Extensions.Options;
using System.Diagnostics.CodeAnalysis;
using static ServiceDescriptor;

/// <summary>
/// Provides ASP.NET Core API Explorer specific extension methods for <see cref="IApiVersioningBuilder"/>.
/// </summary>
[CLSCompliant( false )]
public static class IApiVersioningBuilderExtensions
{
    private const string TrimmingMessage = "MVC does not currently support trimming or native AOT. https://aka.ms/aspnet/trimming";

    /// <param name="builder">The extended <see cref="IApiVersioningBuilder">API versioning builder</see>.</param>
    /// <returns>The original <paramref name="builder"/>.</returns>
    extension( IApiVersioningBuilder builder )
    {
        /// <summary>
        /// Adds the API versioning extensions for the API Explorer.
        /// </summary>
        [RequiresUnreferencedCode( TrimmingMessage )]
        public IApiVersioningBuilder AddApiExplorer()
        {
            ArgumentNullException.ThrowIfNull( builder );
            AddApiExplorerServices( builder );
            return builder;
        }

        /// <summary>
        /// Adds the API versioning extensions for the API Explorer.
        /// </summary>
        /// <param name="setupAction">An <see cref="Action{T}">action</see> used to configure the provided options.</param>
        [RequiresUnreferencedCode( TrimmingMessage )]
        public IApiVersioningBuilder AddApiExplorer( Action<ApiExplorerOptions> setupAction )
        {
            ArgumentNullException.ThrowIfNull( builder );
            AddApiExplorerServices( builder );
            builder.Services.Configure( setupAction );
            return builder;
        }
    }

    [RequiresUnreferencedCode( TrimmingMessage )]
    private static void AddApiExplorerServices( IApiVersioningBuilder builder )
    {
        builder.AddMvc();

        var services = builder.Services;

        services.AddMvcCore().AddApiExplorer();
        services.AddEndpointsApiExplorer();
        services.TryAddSingleton<IOptionsFactory<ApiExplorerOptions>, ApiExplorerOptionsFactory<ApiExplorerOptions>>();
        services.TryAddTransient<IApiVersionDescriptionProviderFactory, ApiVersionDescriptionProviderFactory>();
        services.TryAddSingleton( static sp => sp.GetRequiredService<IApiVersionDescriptionProviderFactory>().Create() );

        // use internal constructor until ASP.NET Core fixes their bug
        // BUG: https://github.com/dotnet/aspnetcore/issues/41773
        services.TryAddEnumerable(
            Transient<IApiDescriptionProvider, VersionedApiDescriptionProvider>(
                static sp => new(
                    sp.GetRequiredService<IPolicyManager<SunsetPolicy>>(),
                    sp.GetRequiredService<IPolicyManager<DeprecationPolicy>>(),
                    sp.GetRequiredService<IModelMetadataProvider>(),
                    sp.GetRequiredService<IInlineConstraintResolver>(),
                    sp.GetRequiredService<IOptions<ApiExplorerOptions>>() ) ) );
    }
}