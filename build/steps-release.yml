parameters:
- name: configuration
  type: string
  default: Release
- name: versionSuffix
  type: string
  default: ''

steps:
- task: DotNetCoreCLI@2
  displayName: Pack Packages
  inputs:
    command: pack
    projects: asp.slnx
    ${{ if eq(parameters.versionSuffix, '') }}:
        arguments: --no-build --configuration ${{ parameters.configuration }}
    ${{ else }}:
        arguments: --no-build --configuration ${{ parameters.configuration }} --version-suffix ${{ parameters.versionSuffix }}
    outputDir: $(Build.ArtifactStagingDirectory)/packages
    noBuild: true

- script: dotnet tool restore
  displayName: Restore Tools

- script: >
    dotnet sign code azure-key-vault "*.nupkg"
    --base-directory "$(Build.ArtifactStagingDirectory)/packages"
    --publisher-name "ASP.NET API Versioning"
    --description "Adds versioning semantics to APIs built with ASP.NET"
    --description-url "https://github.com/dotnet/aspnet-api-versioning"
    --azure-key-vault-tenant-id "$(SignTenantId)"
    --azure-key-vault-client-id "$(SignClientId)"
    --azure-key-vault-client-secret "$(SignClientSecret)"
    --azure-key-vault-certificate "$(SignKeyVaultCertificate)"
    --azure-key-vault-url "$(SignKeyVaultUrl)"
    --timestamp-url http://timestamp.digicert.com
  displayName: Sign Artifacts

- powershell: |
    Invoke-WebRequest `
      -Uri https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-win-x64.exe `
      -OutFile sbom-tool.exe
  displayName: Download SBOM Tool

- powershell: |
    .\sbom-tool.exe generate `
      -b "$(Build.ArtifactStagingDirectory)" `
      -bc "$(Build.SourcesDirectory)" `
      -pn "ASP.NET API Versioning" `
      -pv "$(Build.BuildNumber)" `
      -ps ".NET Foundation" `
      -nsb "urn:dnf:aspnet-api-versioning" `
      -mi SPDX:3.0
      -V Verbose
  displayName: Generate SBOM

- task: PublishBuildArtifacts@1
  displayName: Publish Artifacts
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)/packages
    publishLocation: Container
    artifactName: NuGet Packages

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: /$(Build.ArtifactStagingDirectory)/_manifest
    artifact: sbom
  displayName: Publish SBOM
